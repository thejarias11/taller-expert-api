<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Users - Taller Expert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056a3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #000; }
        input, select {
            width: 200px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Usuarios - Taller Expert</h1>
        
        <div class="section">
            <h2>1Ô∏è‚É£ Cargar Lista de Usuarios</h2>
            <button onclick="loadUsers()" class="btn-success">üìã Cargar Usuarios</button>
            <div id="usersList"></div>
        </div>

        <div class="section">
            <h2>2Ô∏è‚É£ Test Actualizaci√≥n Manual</h2>
            <div class="form-group">
                <label>ID Usuario:</label>
                <input type="text" id="testUserId" placeholder="Ej: 1">
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="testNombre" placeholder="Nuevo nombre">
            </div>
            <div class="form-group">
                <label>Usuario:</label>
                <input type="text" id="testUsername" placeholder="nuevo_usuario">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="testEmail" placeholder="email@test.com">
            </div>
            <div class="form-group">
                <label>Rol:</label>
                <select id="testRole">
                    <option value="empleado">Empleado</option>
                    <option value="admin">Admin</option>
                    <option value="super_admin">Super Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="testPassword" placeholder="Dejar vac√≠o para no cambiar">
            </div>
            <button onclick="testUpdateUser()" class="btn-warning">üîß Test Actualizar</button>
        </div>

        <div class="section">
            <h2>3Ô∏è‚É£ Test Directo de API</h2>
            <button onclick="testApiDirect()" class="btn-danger">üî• Test API Directo (PUT)</button>
        </div>

        <div class="section">
            <h2>üìú Logs de Debug</h2>
            <button onclick="clearLogs()" class="btn-warning">üßπ Limpiar Logs</button>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        let debugLogElement = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logMessage = `[${timestamp}] ${emoji} ${message}\n`;
            debugLogElement.textContent += logMessage;
            debugLogElement.scrollTop = debugLogElement.scrollHeight;
            console.log(logMessage);
        }

        function clearLogs() {
            debugLogElement.textContent = '';
        }

        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            
            if (!token) {
                throw new Error('No hay token de autenticaci√≥n');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            log(`üåê Haciendo petici√≥n a: ${url}`);
            log(`üîß M√©todo: ${options.method || 'GET'}`);
            log(`üîë Token: ${token.substring(0, 20)}...`);

            const response = await fetch(url, { ...options, headers: defaultOptions.headers });
            
            log(`üì• Respuesta: ${response.status} ${response.statusText}`);
            
            return response;
        }

        async function loadUsers() {
            log('üìã Cargando usuarios...');
            
            try {
                const response = await makeAuthenticatedRequest('/api/auth/users');
                const data = await response.json();
                
                log(`üìä Respuesta: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success) {
                    let html = '<h4>üë• Usuarios encontrados:</h4>';
                    data.data.forEach(user => {
                        html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>ID:</strong> ${user.id} | 
                                <strong>Nombre:</strong> ${user.nombre} | 
                                <strong>Usuario:</strong> ${user.username} | 
                                <strong>Rol:</strong> ${user.role}
                                <br><button onclick="fillTestForm('${user.id}', '${user.nombre}', '${user.username}', '${user.email || ''}', '${user.role}')" 
                                style="background: #28a745; color: white; border: none; padding: 5px 10px; margin-top: 5px; border-radius: 3px;">
                                ‚¨áÔ∏è Usar para test</button>
                            </div>
                        `;
                    });
                    document.getElementById('usersList').innerHTML = html;
                    log(`‚úÖ ${data.data.length} usuarios cargados`, 'success');
                } else {
                    log(`‚ùå Error: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`üí• Error cargando usuarios: ${error.message}`, 'error');
            }
        }

        function fillTestForm(id, nombre, username, email, role) {
            document.getElementById('testUserId').value = id;
            document.getElementById('testNombre').value = nombre;
            document.getElementById('testUsername').value = username;
            document.getElementById('testEmail').value = email;
            document.getElementById('testRole').value = role;
            log(`üìù Formulario llenado con datos del usuario ${username}`, 'info');
        }

        async function testUpdateUser() {
            const userId = document.getElementById('testUserId').value;
            const userData = {
                nombre: document.getElementById('testNombre').value,
                username: document.getElementById('testUsername').value,
                email: document.getElementById('testEmail').value,
                role: document.getElementById('testRole').value
            };

            const password = document.getElementById('testPassword').value;
            if (password) {
                userData.password = password;
            }

            log('üîß Iniciando test de actualizaci√≥n...');
            log(`üë§ UserId: ${userId}`);
            log(`üìä Datos: ${JSON.stringify(userData, null, 2)}`);

            if (!userId) {
                log('‚ùå ID de usuario requerido', 'error');
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(`/api/auth/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                log(`üìä Respuesta completa: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    log('‚úÖ Usuario actualizado exitosamente!', 'success');
                } else {
                    log(`‚ùå Error en actualizaci√≥n: ${data.message}`, 'error');
                }
                
            } catch (error) {
                log(`üí• Error en test: ${error.message}`, 'error');
            }
        }

        async function testApiDirect() {
            log('üî• Test directo de API...');
            
            const testData = {
                nombre: "Usuario Test",
                username: "test_user_" + Date.now(),
                email: "test@example.com",
                role: "empleado"
            };

            try {
                // Crear usuario primero
                log('üì§ Creando usuario de prueba...');
                const createResponse = await makeAuthenticatedRequest('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ ...testData, password: 'test123' })
                });

                const createData = await createResponse.json();
                log(`üìä Usuario creado: ${JSON.stringify(createData, null, 2)}`);

                if (createData.success) {
                    const userId = createData.data.id;
                    
                    // Actualizar usuario
                    log('üì§ Actualizando usuario de prueba...');
                    const updateData = {
                        nombre: "Usuario Test Actualizado",
                        email: "updated@example.com",
                        role: "admin"
                    };

                    const updateResponse = await makeAuthenticatedRequest(`/api/auth/users/${userId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updateData)
                    });

                    const updateResult = await updateResponse.json();
                    log(`üìä Resultado actualizaci√≥n: ${JSON.stringify(updateResult, null, 2)}`);

                    if (updateResult.success) {
                        log('‚úÖ Test API directo EXITOSO!', 'success');
                    } else {
                        log(`‚ùå Test API fall√≥: ${updateResult.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`üí• Error en test directo: ${error.message}`, 'error');
            }
        }

        // Auto-cargar usuarios al inicio
        window.addEventListener('load', () => {
            log('üîß Debug de usuarios cargado');
            
            // Verificar token
            const token = localStorage.getItem('token');
            if (token) {
                log(`‚úÖ Token encontrado: ${token.substring(0, 20)}...`);
                loadUsers();
            } else {
                log('‚ùå No hay token. Ve al login primero.', 'error');
            }
        });
    </script>
</body>
</html>