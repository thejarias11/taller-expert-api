<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Taller Expert</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>üèçÔ∏è Taller Expert - Panel de Control</h1>
            <div class="user-info">
                <span id="userWelcome">Bienvenido</span>
                <button onclick="logout()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </header>

        <nav class="sidebar">
            <a href="#products" onclick="showSection('products')">üì¶ Productos</a>
            <a href="#appointments" onclick="showSection('appointments')">üìÖ Citas</a>
            <a href="#sales" onclick="showSection('sales')">üí∞ Ventas</a>
            <a href="#users" onclick="showSection('users')">üë• Usuarios</a>
        </nav>

        <main class="content">
            <!-- Secci√≥n de Productos -->
            <div id="products" class="section active">
                <h2>üì¶ Gesti√≥n de Productos</h2>
                
                <div class="actions">
                    <button onclick="loadProducts()" class="btn-primary">üîÑ Cargar Productos</button>
                    <button onclick="showCreateProduct()" class="btn-success">+ Nuevo Producto</button>
                </div>

                <!-- Filtros de Productos -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Buscar Producto:</label>
                        <input type="text" id="productSearchFilter" placeholder="Nombre o descripci√≥n...">
                    </div>
                    <div class="filter-group">
                        <label>Categor√≠a:</label>
                        <select id="productCategoryFilter">
                            <option value="">Todas las categor√≠as</option>
                            <option value="repuesto">Repuestos</option>
                            <option value="lubricante">Lubricantes</option>
                            <option value="llanta">Llantas</option>
                            <option value="accesorio">Accesorios</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Stock M√≠nimo:</label>
                        <input type="number" id="minStockFilter" min="0" placeholder="0">
                    </div>
                    <div class="filter-group">
                        <label>Precio M√°ximo:</label>
                        <input type="number" id="maxPriceFilter" min="0" placeholder="Sin l√≠mite">
                    </div>
                    <button onclick="filterProducts()" class="btn-secondary">üîç Filtrar</button>
                    <button onclick="clearProductFilters()" class="btn-warning">üóëÔ∏è Limpiar</button>
                </div>

                <div id="productsList" class="data-container"></div>
            </div>

            <!-- Secci√≥n de Citas -->
            <div id="appointments" class="section">
                <h2>üìÖ Gesti√≥n de Citas</h2>
                
                <div class="actions">
                    <button onclick="loadAppointments()" class="btn-primary">üîÑ Cargar Citas</button>
                    <button onclick="showCreateAppointment()" class="btn-success">+ Nueva Cita</button>
                </div>

                <!-- Filtros de Citas -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Buscar Cliente:</label>
                        <input type="text" id="clientSearchFilter" placeholder="Nombre del cliente...">
                    </div>
                    <div class="filter-group">
                        <label>Tipo de Servicio:</label>
                        <select id="serviceTypeFilter">
                            <option value="">Todos los servicios</option>
                            <option value="Cambio de aceite">Cambio de aceite</option>
                            <option value="Reparaci√≥n general">Reparaci√≥n general</option>
                            <option value="Afinamiento">Afinamiento</option>
                            <option value="Lavado y detailing">Lavado y detailing</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Fecha Desde:</label>
                        <input type="date" id="appointmentStartDate">
                    </div>
                    <div class="filter-group">
                        <label>Fecha Hasta:</label>
                        <input type="date" id="appointmentEndDate">
                    </div>
                    <button onclick="filterAppointments()" class="btn-secondary">üîç Filtrar</button>
                    <button onclick="clearAppointmentFilters()" class="btn-warning">üóëÔ∏è Limpiar</button>
                </div>

                <div id="appointmentsList" class="data-container"></div>
            </div>

            <!-- Secci√≥n de Ventas -->
            <div id="sales" class="section">
                <h2>üí∞ Gesti√≥n de Ventas</h2>
                
                <!-- Estad√≠sticas de Ventas -->
                <div class="sales-stats" id="salesStats">
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-info">
                            <h3 id="todaySales">0</h3>
                            <p>Ventas Hoy</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-info">
                            <h3 id="todayRevenue">$0</h3>
                            <p>Ingresos Hoy</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-info">
                            <h3 id="monthSales">0</h3>
                            <p>Ventas del Mes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-info">
                            <h3 id="totalRevenue">$0</h3>
                            <p>Total Ingresos</p>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="loadSales()" class="btn-primary">üîÑ Cargar Ventas</button>
                    <button onclick="showCreateSale()" class="btn-success">+ Nueva Venta</button>
                    <button onclick="loadSalesStats()" class="btn-info">üìä Estad√≠sticas</button>
                </div>

                <!-- Filtros de B√∫squeda -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Fecha Desde:</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label>Fecha Hasta:</label>
                        <input type="date" id="endDate">
                    </div>
                    <button onclick="filterSales()" class="btn-secondary">üîç Filtrar</button>
                </div>

                <div id="salesList" class="data-container"></div>
            </div>

                        <!-- Formulario para crear producto (solo admin) -->
            <div id="createProductForm" class="form-section" style="display: none;">
                <h3>‚ûï Agregar Nuevo Producto</h3>
                <form id="productForm">
                    <div class="form-group">
                        <label>Nombre del Producto:</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <input type="text" id="productDescription">
                    </div>
                    <div class="form-group">
                        <label>Precio:</label>
                        <input type="number" id="productPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Stock:</label>
                        <input type="number" id="productStock" required>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <select id="productCategory">
                            <option value="repuesto">Repuesto</option>
                            <option value="lubricante">Lubricante</option>
                            <option value="llanta">Llanta</option>
                            <option value="accesorio">Accesorio</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-success">Guardar Producto</button>
                    <button type="button" onclick="hideCreateProduct()" class="btn-secondary">Cancelar</button>
                </form>
            </div>

            <!-- Formulario para crear cita -->
            <div id="createAppointmentForm" class="form-section" style="display: none;">
                <h3>üìÖ Agendar Nueva Cita</h3>
                <form id="appointmentForm">
                    <div class="form-group">
                        <label>Nombre del Cliente:</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono:</label>
                        <input type="text" id="clientPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Modelo de Moto:</label>
                        <input type="text" id="motorcycleModel" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Servicio:</label>
                        <select id="serviceType">
                            <option value="Cambio de aceite">Cambio de aceite</option>
                            <option value="Reparaci√≥n general">Reparaci√≥n general</option>
                            <option value="Afinamiento">Afinamiento</option>
                            <option value="Lavado y detailing">Lavado y detailing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora:</label>
                        <input type="datetime-local" id="scheduledDate" required>
                    </div>
                    <button type="submit" class="btn-success">Agendar Cita</button>
                    <button type="button" onclick="hideCreateAppointment()" class="btn-secondary">Cancelar</button>
                </form>
            </div>

            <!-- Formulario para crear venta -->
            <div id="createSaleForm" class="form-section" style="display: none;">
                <h3>üí∞ Nueva Venta</h3>
                
                <!-- B√∫squeda de Productos (FUERA del formulario) -->
                <div class="products-section">
                    <h4>üõí Productos</h4>
                    <div class="product-search">
                        <input type="text" id="productSearch" placeholder="Buscar productos..." onkeypress="if(event.keyCode==13) { event.preventDefault(); searchProducts(); }">
                        <select id="categoryFilter">
                            <option value="">Todas las categor√≠as</option>
                            <option value="repuesto">Repuestos</option>
                            <option value="lubricante">Lubricantes</option>
                            <option value="llanta">Llantas</option>
                            <option value="accesorio">Accesorios</option>
                        </select>
                        <button type="button" onclick="searchProducts()" class="btn-info">üîç Buscar</button>
                    </div>
                    
                    <div id="productResults" class="product-results"></div>
                    
                    <div class="selected-products">
                        <h5>üì¶ Productos Seleccionados</h5>
                        <div id="selectedProducts" class="selected-items"></div>
                        <div class="total-section">
                            <strong>Total: $<span id="totalAmount">0</span></strong>
                        </div>
                    </div>
                </div>

                <!-- FORMULARIO DE VENTA (solo para finalizar) -->
                <form id="saleForm">

                    <!-- Informaci√≥n de Pago -->
                    <div class="payment-section">
                        <h4>üí≥ Informaci√≥n de Pago</h4>
                        <div class="form-group">
                            <label>M√©todo de Pago:</label>
                            <select id="paymentMethod">
                                <option value="cash">Efectivo</option>
                                <option value="card">Tarjeta</option>
                                <option value="transfer">Transferencia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notas (opcional):</label>
                            <textarea id="saleNotes" rows="3" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-success">üí∞ Registrar Venta</button>
                        <button type="button" onclick="hideCreateSale()" class="btn-secondary">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Secci√≥n de Usuarios -->
            <div id="users" class="section">
                <h2>üë§ Informaci√≥n del Usuario</h2>
                <div class="user-profile-section">
                    <div class="profile-card">
                        <div class="profile-header">
                            <i class="fas fa-user-circle profile-avatar"></i>
                            <div class="profile-info">
                                <h3 id="profileName">Cargando...</h3>
                                <p id="profileRole">Rol del usuario</p>
                                <p id="profileEmail">Email del usuario</p>
                            </div>
                        </div>
                        <div class="profile-details">
                            <div class="detail-item">
                                <strong>Estado de la cuenta:</strong>
                                <span class="status-active">‚úÖ Activa</span>
                            </div>
                            <div class="detail-item">
                                <strong>√öltima sesi√≥n:</strong>
                                <span id="lastLogin">Ahora</span>
                            </div>
                            <div class="detail-item">
                                <strong>Permisos:</strong>
                                <span id="userPermissions">Gesti√≥n completa del sistema</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="userInfo" class="data-container"></div>
            </div>
        </main>

        <div id="message" class="message"></div>
    </div>

    <script>
        // Verificaci√≥n inmediata de autenticaci√≥n (antes de que se cargue la p√°gina)
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.replace('login.html');
                return;
            }
        })();

        // Verificar autenticaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token) {
                alert('Debe iniciar sesi√≥n para acceder al dashboard');
                window.location.href = 'login.html';
                return;
            }

            // Verificar si el token es v√°lido haciendo una petici√≥n al servidor
            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token inv√°lido');
                }

                // Si llegamos aqu√≠, el token es v√°lido
                document.getElementById('userWelcome').textContent = 
                    `Bienvenido, ${user.username} (${user.role})`;
                
                showUserInfo();
                
            } catch (error) {
                console.error('Error de autenticaci√≥n:', error);
                alert('Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('rememberMe');
                window.location.href = 'login.html';
            }
        });

        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Ocultar todos los formularios al cambiar de pesta√±a
            hideCreateProduct();
            hideCreateAppointment();
            hideCreateSale();
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            // Cargar datos espec√≠ficos de la secci√≥n
            if (sectionId === 'sales') {
                loadSalesStats();
                loadSales();
            }
        }

        function showUserInfo() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            
            // Actualizar informaci√≥n del perfil
            document.getElementById('profileName').textContent = user.nombre || user.username || 'Usuario';
            document.getElementById('profileRole').textContent = getRoleDisplayName(user.role);
            document.getElementById('profileEmail').textContent = user.email || 'admin@tallerexpert.com';
            document.getElementById('lastLogin').textContent = new Date().toLocaleString('es-ES');
            document.getElementById('userPermissions').textContent = getRolePermissions(user.role);
            
            // Informaci√≥n t√©cnica en la secci√≥n inferior
            document.getElementById('userInfo').innerHTML = `
                <div class="info-card technical-info">
                    <h3>ÔøΩ Informaci√≥n T√©cnica</h3>
                    <div class="tech-details">
                        <div class="tech-item">
                            <strong>ID de Usuario:</strong> 
                            <code>${user.userId || user.id || 'N/A'}</code>
                        </div>
                        <div class="tech-item">
                            <strong>Nombre de Usuario:</strong> 
                            <code>${user.username}</code>
                        </div>
                        <div class="tech-item">
                            <strong>Rol del Sistema:</strong> 
                            <code>${user.role}</code>
                        </div>
                        <div class="tech-item">
                            <strong>Token de Sesi√≥n:</strong> 
                            <code class="token-preview">${token ? token.substring(0, 30) + '...' : 'No disponible'}</code>
                        </div>
                        <div class="tech-item">
                            <strong>Expiraci√≥n de Sesi√≥n:</strong> 
                            <code>8 horas desde el login</code>
                        </div>
                    </div>
                </div>
            `;
        }

        function getRoleDisplayName(role) {
            switch(role) {
                case 'super_admin': return 'üëë Super Administrador';
                case 'admin': return 'üîë Administrador';
                case 'manager': return 'üìä Gerente';
                case 'employee': return 'üë§ Empleado';
                default: return 'üë§ Usuario';
            }
        }

        function getRolePermissions(role) {
            switch(role) {
                case 'super_admin': return 'Acceso total al sistema, gesti√≥n de usuarios y configuraci√≥n';
                case 'admin': return 'Gesti√≥n completa de productos, citas y ventas';
                case 'manager': return 'Supervisi√≥n de operaciones y reportes';
                case 'employee': return 'Gesti√≥n b√°sica de citas y consulta de productos';
                default: return 'Permisos b√°sicos del sistema';
            }
        }

        async function loadProducts() {
            const token = localStorage.getItem('token');
            const messageDiv = document.getElementById('message');

            try {
                const response = await fetch('/api/products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('productsList').innerHTML = `
                        <div class="success">
                            ‚úÖ ${data.message || 'Productos cargados correctamente'}
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="error">
                            ‚ùå ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        async function loadAppointments() {
            const token = localStorage.getItem('token');
            const messageDiv = document.getElementById('message');

            try {
                const response = await fetch('/api/appointments', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('appointmentsList').innerHTML = `
                        <div class="success">
                            ‚úÖ ${data.message || 'Citas cargadas correctamente'}
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="error">
                            ‚ùå ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        function logout() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('rememberMe');
                alert('Sesi√≥n cerrada exitosamente');
                window.location.href = 'login.html';
            }
        }

        // Funciones para mostrar/ocultar formularios
        function showCreateProduct() {
            document.getElementById('createProductForm').style.display = 'block';
            document.getElementById('productsList').innerHTML = '';
        }

        function hideCreateProduct() {
            document.getElementById('createProductForm').style.display = 'none';
        }

        function showCreateAppointment() {
            document.getElementById('createAppointmentForm').style.display = 'block';
            document.getElementById('appointmentsList').innerHTML = '';
        }

        function hideCreateAppointment() {
            document.getElementById('createAppointmentForm').style.display = 'none';
        }

        // Crear nuevo producto
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                category: document.getElementById('productCategory').value
            };

            try {
                const response = await makeAuthenticatedRequest('/api/products', {
                    method: 'POST',
                    body: JSON.stringify(productData)
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('message').innerHTML = `
                        <div class="success">‚úÖ Producto creado exitosamente</div>
                    `;
                    hideCreateProduct();
                    loadProducts(); // Recargar la lista
                    document.getElementById('productForm').reset(); // Limpiar formulario
                } else {
                    document.getElementById('message').innerHTML = `
                        <div class="error">‚ùå ${data.message}</div>
                    `;
                }
            } catch (error) {
                console.error('Error creando producto:', error);
                if (!error.message.includes('Token inv√°lido')) {
                    document.getElementById('message').innerHTML = `
                        <div class="error">‚ùå Error al crear el producto: ${error.message}</div>
                    `;
                }
            }
        });

        // Crear nueva cita
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            const appointmentData = {
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                motorcycleModel: document.getElementById('motorcycleModel').value,
                serviceType: document.getElementById('serviceType').value,
                scheduledDate: document.getElementById('scheduledDate').value
            };

            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('message').innerHTML = `
                        <div class="success">‚úÖ ${data.message}</div>
                    `;
                    hideCreateAppointment();
                    loadAppointments(); // Recargar la lista
                } else {
                    document.getElementById('message').innerHTML = `
                        <div class="error">‚ùå ${data.message}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('message').innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                `;
            }
        });

        // Mejorar la funci√≥n loadProducts para mostrar datos bonitos
        async function loadProducts() {
            const token = localStorage.getItem('token');
            const messageDiv = document.getElementById('message');

            try {
                const response = await fetch('/api/products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        let html = '<h3>üì¶ Lista de Productos</h3>';
                        html += '<div class="products-grid">';
                        
                        data.data.forEach(product => {
                            html += `
                                <div class="product-card">
                                    <h4>${product.name}</h4>
                                    <p>${product.description}</p>
                                    <p><strong>Precio:</strong> $${product.price}</p>
                                    <p><strong>Stock:</strong> ${product.stock} unidades</p>
                                    <p><strong>Categor√≠a:</strong> ${product.category}</p>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        document.getElementById('productsList').innerHTML = html;
                    } else {
                        document.getElementById('productsList').innerHTML = `
                            <div class="info">
                                üìù No hay productos registrados. ¬°Agrega el primero!
                            </div>
                        `;
                    }
                } else {
                    messageDiv.innerHTML = `
                        <div class="error">‚ùå ${data.message}</div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        // Mejorar la funci√≥n loadAppointments
        async function loadAppointments() {
            const token = localStorage.getItem('token');
            const messageDiv = document.getElementById('message');

            try {
                const response = await fetch('/api/appointments', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        let html = '<h3>üìÖ Citas Agendadas</h3>';
                        html += '<div class="appointments-list">';
                        
                        data.data.forEach(appointment => {
                            const date = new Date(appointment.scheduledDate);
                            html += `
                                <div class="appointment-card">
                                    <h4>${appointment.clientName} - ${appointment.motorcycleModel}</h4>
                                    <p><strong>Servicio:</strong> ${appointment.serviceType}</p>
                                    <p><strong>Tel√©fono:</strong> ${appointment.clientPhone}</p>
                                    <p><strong>Fecha:</strong> ${date.toLocaleString()}</p>
                                    <p><strong>Estado:</strong> ${appointment.status}</p>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        document.getElementById('appointmentsList').innerHTML = html;
                    } else {
                        document.getElementById('appointmentsList').innerHTML = `
                            <div class="info">
                                üìù No hay citas agendadas. ¬°Agrega la primera!
                            </div>
                        `;
                    }
                } else {
                    messageDiv.innerHTML = `
                        <div class="error">‚ùå ${data.message}</div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        // ========== FUNCI√ìN HELPER PARA MANEJAR AUTENTICACI√ìN ==========
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            
            if (!token) {
                throw new Error('No hay token de autenticaci√≥n');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...options, headers: defaultOptions.headers });
            
            if (response.status === 401 || response.status === 403) {
                alert('Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('rememberMe');
                window.location.href = 'login.html';
                throw new Error('Token inv√°lido o expirado');
            }

            return response;
        }

        // ========== FUNCIONES DE VENTAS ==========
        let selectedProducts = [];
        let availableProducts = [];

        // Cargar estad√≠sticas de ventas
        async function loadSalesStats() {
            try {
                const response = await makeAuthenticatedRequest('/api/sales/stats');
                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('todaySales').textContent = stats.today.count;
                    document.getElementById('todayRevenue').textContent = `$${stats.today.revenue.toLocaleString()}`;
                    document.getElementById('monthSales').textContent = stats.month.count;
                    document.getElementById('totalRevenue').textContent = `$${stats.total.revenue.toLocaleString()}`;
                } else {
                    console.error('Error en la respuesta:', data.message);
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                if (!error.message.includes('Token inv√°lido')) {
                    alert('Error al cargar las estad√≠sticas de ventas');
                }
            }
        }

        // Cargar ventas
        async function loadSales() {
            try {
                const response = await makeAuthenticatedRequest('/api/sales');
                const data = await response.json();

                if (data.success) {
                    displaySales(data.sales, data.statistics);
                } else {
                    document.getElementById('salesList').innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error cargando ventas:', error);
                if (!error.message.includes('Token inv√°lido')) {
                    document.getElementById('salesList').innerHTML = `<div class="error">‚ùå Error al cargar las ventas</div>`;
                }
            }
        }

        // Mostrar ventas
        function displaySales(sales, statistics) {
            let html = '<h3>üí∞ Lista de Ventas</h3>';
            
            if (statistics) {
                html += `
                    <div class="sales-summary">
                        <p><strong>Total Ventas:</strong> ${statistics.totalSales}</p>
                        <p><strong>Ingresos Totales:</strong> $${statistics.totalRevenue.toLocaleString()}</p>
                        <p><strong>Venta Promedio:</strong> $${statistics.averageSale.toLocaleString()}</p>
                    </div>
                `;
            }

            if (sales && sales.length > 0) {
                html += '<div class="sales-grid">';
                
                sales.forEach(sale => {
                    const date = new Date(sale.createdAt).toLocaleDateString();
                    const time = new Date(sale.createdAt).toLocaleTimeString();
                    
                    html += `
                        <div class="sale-card">
                            <div class="sale-header">
                                <h4>${sale.saleNumber}</h4>
                                <span class="sale-status ${sale.status}">${sale.status}</span>
                            </div>
                            <div class="sale-info">
                                <p><strong>Total:</strong> $${sale.totalAmount.toLocaleString()}</p>
                                <p><strong>Vendedor:</strong> ${sale.sellerName}</p>
                                <p><strong>Fecha:</strong> ${date} ${time}</p>
                                <p><strong>Pago:</strong> ${sale.paymentMethod}</p>
                            </div>
                            <div class="sale-items">
                                <strong>Productos:</strong>
                                <ul>
                                    ${sale.items.map(item => 
                                        `<li>${item.productName} - Cant: ${item.quantity} - $${item.subtotal.toLocaleString()}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<p>No hay ventas registradas.</p>';
            }

            document.getElementById('salesList').innerHTML = html;
        }

        // Mostrar formulario de nueva venta
        function showCreateSale() {
            document.getElementById('createSaleForm').style.display = 'block';
            // Cargar productos disponibles
            loadProductsForSale();
        }

        // Ocultar formulario de nueva venta
        function hideCreateSale() {
            document.getElementById('createSaleForm').style.display = 'none';
            selectedProducts = [];
            updateSelectedProducts();
        }

        // Cargar productos para venta
        async function loadProductsForSale() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/sales/products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    availableProducts = data.products;
                }
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }

        // Buscar productos
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            
            let filteredProducts = availableProducts.filter(product => {
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) || 
                    product.description.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !category || product.category === category;
                
                return matchesSearch && matchesCategory;
            });

            displayProductResults(filteredProducts);
        }

        // Mostrar resultados de b√∫squeda de productos
        function displayProductResults(products) {
            let html = '';
            
            if (products.length > 0) {
                html = '<div class="product-search-results">';
                products.forEach(product => {
                    html += `
                        <div class="product-result-item">
                            <div class="product-info">
                                <h5>${product.name}</h5>
                                <p>${product.description}</p>
                                <p><strong>$${product.price.toLocaleString()}</strong> - Stock: ${product.stock}</p>
                            </div>
                            <div class="product-actions">
                                <input type="number" id="qty-${product.id}" min="1" max="${product.stock}" value="1" class="quantity-input">
                                <button type="button" onclick="addProductToSale('${product.id}')" class="btn-success btn-sm">+ Agregar</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html = '<p>No se encontraron productos.</p>';
            }

            document.getElementById('productResults').innerHTML = html;
        }

        // Agregar producto a la venta
        function addProductToSale(productId) {
            const product = availableProducts.find(p => p.id === productId);
            const quantityInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(quantityInput.value);

            if (!product || quantity <= 0 || quantity > product.stock) {
                alert('Cantidad inv√°lida o stock insuficiente');
                return;
            }

            // Verificar si el producto ya est√° en la lista
            const existingIndex = selectedProducts.findIndex(p => p.id === productId);
            
            if (existingIndex >= 0) {
                // Actualizar cantidad
                selectedProducts[existingIndex].quantity += quantity;
            } else {
                // Agregar nuevo producto
                selectedProducts.push({
                    ...product,
                    quantity: quantity
                });
            }

            updateSelectedProducts();
        }

        // Actualizar lista de productos seleccionados
        function updateSelectedProducts() {
            let html = '';
            let total = 0;

            if (selectedProducts.length > 0) {
                html = '<div class="selected-products-list">';
                selectedProducts.forEach((product, index) => {
                    const subtotal = product.price * product.quantity;
                    total += subtotal;
                    
                    html += `
                        <div class="selected-product-item">
                            <div class="product-details">
                                <strong>${product.name}</strong>
                                <p>$${product.price.toLocaleString()} x ${product.quantity} = $${subtotal.toLocaleString()}</p>
                            </div>
                            <button type="button" onclick="removeProductFromSale(${index})" class="btn-danger btn-sm">Eliminar</button>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html = '<p>No hay productos seleccionados.</p>';
            }

            document.getElementById('selectedProducts').innerHTML = html;
            document.getElementById('totalAmount').textContent = total.toLocaleString();
        }

        // Eliminar producto de la venta
        function removeProductFromSale(index) {
            selectedProducts.splice(index, 1);
            updateSelectedProducts();
        }

        // Manejar env√≠o de formulario de venta
        document.getElementById('saleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (selectedProducts.length === 0) {
                alert('Debe agregar al menos un producto a la venta');
                return;
            }

            const token = localStorage.getItem('token');
            const saleData = {
                paymentMethod: document.getElementById('paymentMethod').value,
                notes: document.getElementById('saleNotes').value,
                items: selectedProducts.map(product => ({
                    productId: product.id,
                    quantity: product.quantity
                }))
            };

            try {
                const response = await fetch('/api/sales', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(saleData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Venta registrada exitosamente');
                    hideCreateSale();
                    loadSales();
                    loadSalesStats();
                    document.getElementById('saleForm').reset();
                } else {
                    alert(`‚ùå Error: ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        });

        // Filtrar ventas
        function filterSales() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);

            const token = localStorage.getItem('token');
            
            fetch(`/api/sales?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySales(data.sales, data.statistics);
                }
            })
            .catch(error => {
                console.error('Error filtrando ventas:', error);
            });
        }

        // Cargar estad√≠sticas al mostrar la secci√≥n de ventas (eliminada funci√≥n duplicada)

        // ========== FUNCIONES DE FILTROS PARA PRODUCTOS ==========
        function filterProducts() {
            const searchTerm = document.getElementById('productSearchFilter').value;
            const category = document.getElementById('productCategoryFilter').value;
            const minStock = document.getElementById('minStockFilter').value;
            const maxPrice = document.getElementById('maxPriceFilter').value;
            
            const params = new URLSearchParams();
            if (searchTerm) params.append('search', searchTerm);
            if (category) params.append('category', category);
            if (minStock) params.append('minStock', minStock);
            if (maxPrice) params.append('maxPrice', maxPrice);

            const token = localStorage.getItem('token');
            
            fetch(`/api/products?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayProductsFiltered(data.data || data.products);
                } else {
                    document.getElementById('productsList').innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('productsList').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            });
        }

        function displayProductsFiltered(products) {
            let html = '<h3>üì¶ Productos Filtrados</h3>';
            
            if (products && products.length > 0) {
                html += `<p class="filter-results">Se encontraron ${products.length} productos</p>`;
                html += '<div class="products-grid-enhanced">';
                
                products.forEach(product => {
                    const stockStatus = product.stock <= 5 ? 'low-stock' : 'normal-stock';
                    const stockIcon = product.stock <= 5 ? '‚ö†Ô∏è' : '‚úÖ';
                    
                    html += `
                        <div class="product-card-enhanced">
                            <div class="product-header">
                                <h4>${product.name}</h4>
                                <span class="category-badge ${product.category}">${product.category}</span>
                            </div>
                            <div class="product-body">
                                <p class="product-description">${product.description}</p>
                                <div class="product-details">
                                    <div class="price-section">
                                        <span class="price">$${product.price.toLocaleString()}</span>
                                    </div>
                                    <div class="stock-section ${stockStatus}">
                                        ${stockIcon} <span>Stock: ${product.stock}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="no-results">üì≠ No se encontraron productos con los filtros aplicados</div>';
            }

            document.getElementById('productsList').innerHTML = html;
        }

        function clearProductFilters() {
            document.getElementById('productSearchFilter').value = '';
            document.getElementById('productCategoryFilter').value = '';
            document.getElementById('minStockFilter').value = '';
            document.getElementById('maxPriceFilter').value = '';
            loadProducts(); // Recargar todos los productos
        }

        // ========== FUNCIONES DE FILTROS PARA CITAS ==========
        function filterAppointments() {
            const clientName = document.getElementById('clientSearchFilter').value;
            const serviceType = document.getElementById('serviceTypeFilter').value;
            const startDate = document.getElementById('appointmentStartDate').value;
            const endDate = document.getElementById('appointmentEndDate').value;
            
            const params = new URLSearchParams();
            if (clientName) params.append('clientName', clientName);
            if (serviceType) params.append('serviceType', serviceType);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);

            const token = localStorage.getItem('token');
            
            fetch(`/api/appointments?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAppointmentsFiltered(data.data || data.appointments);
                } else {
                    document.getElementById('appointmentsList').innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('appointmentsList').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            });
        }

        function displayAppointmentsFiltered(appointments) {
            let html = '<h3>üìÖ Citas Filtradas</h3>';
            
            if (appointments && appointments.length > 0) {
                html += `<p class="filter-results">Se encontraron ${appointments.length} citas</p>`;
                html += '<div class="appointments-grid-enhanced">';
                
                appointments.forEach(appointment => {
                    const date = new Date(appointment.scheduledDate || appointment.date);
                    const formattedDate = date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const formattedTime = date.toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const statusClass = appointment.status || 'scheduled';
                    const statusIcon = getAppointmentStatusIcon(statusClass);
                    
                    html += `
                        <div class="appointment-card-enhanced">
                            <div class="appointment-header">
                                <h4>${appointment.clientName || appointment.client}</h4>
                                <span class="appointment-status ${statusClass}">${statusIcon} ${statusClass}</span>
                            </div>
                            <div class="appointment-body">
                                <div class="appointment-detail">
                                    <i class="fas fa-phone"></i>
                                    <span>${appointment.clientPhone || appointment.phone}</span>
                                </div>
                                <div class="appointment-detail">
                                    <i class="fas fa-motorcycle"></i>
                                    <span>${appointment.motorcycleModel || appointment.vehicle}</span>
                                </div>
                                <div class="appointment-detail">
                                    <i class="fas fa-tools"></i>
                                    <span>${appointment.serviceType || appointment.service}</span>
                                </div>
                                <div class="appointment-detail">
                                    <i class="fas fa-calendar"></i>
                                    <span>${formattedDate}</span>
                                </div>
                                <div class="appointment-detail">
                                    <i class="fas fa-clock"></i>
                                    <span>${formattedTime}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="no-results">üì≠ No se encontraron citas con los filtros aplicados</div>';
            }

            document.getElementById('appointmentsList').innerHTML = html;
        }

        function getAppointmentStatusIcon(status) {
            switch(status) {
                case 'scheduled': return 'üìÖ';
                case 'in-progress': return 'üîß';
                case 'completed': return '‚úÖ';
                case 'cancelled': return '‚ùå';
                default: return 'üìÖ';
            }
        }

        function clearAppointmentFilters() {
            document.getElementById('clientSearchFilter').value = '';
            document.getElementById('serviceTypeFilter').value = '';
            document.getElementById('appointmentStartDate').value = '';
            document.getElementById('appointmentEndDate').value = '';
            loadAppointments(); // Recargar todas las citas
        }

        // ========== B√öSQUEDA EN TIEMPO REAL ==========
        // Agregar event listeners para b√∫squeda autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            // B√∫squeda autom√°tica de productos despu√©s de 500ms de inactividad
            let productSearchTimeout;
            const productSearch = document.getElementById('productSearchFilter');
            if (productSearch) {
                productSearch.addEventListener('input', function() {
                    clearTimeout(productSearchTimeout);
                    productSearchTimeout = setTimeout(filterProducts, 500);
                });
            }

            // B√∫squeda autom√°tica de citas despu√©s de 500ms de inactividad
            let appointmentSearchTimeout;
            const appointmentSearch = document.getElementById('clientSearchFilter');
            if (appointmentSearch) {
                appointmentSearch.addEventListener('input', function() {
                    clearTimeout(appointmentSearchTimeout);
                    appointmentSearchTimeout = setTimeout(filterAppointments, 500);
                });
            }

            // Filtrado autom√°tico al cambiar selects
            const categoryFilter = document.getElementById('productCategoryFilter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterProducts);
            }

            const serviceFilter = document.getElementById('serviceTypeFilter');
            if (serviceFilter) {
                serviceFilter.addEventListener('change', filterAppointments);
            }
        });
    </script>
</body>
</html>